<template>
    <lightning-card title="Family Matching Recommendations" icon-name="standard:account">
        <!-- Header Actions -->
        <div slot="actions">
            <lightning-button-group>
                <lightning-button
                    label="Run Matching"
                    variant="brand"
                    onclick={handleRunMatching}
                    disabled={isLoading}
                    icon-name="utility:refresh"
                ></lightning-button>
                <lightning-button
                    label={viewModeLabel}
                    icon-name={viewModeIcon}
                    onclick={toggleViewMode}
                    disabled={isLoading}
                ></lightning-button>
            </lightning-button-group>
        </div>
        
        <!-- Loading Spinner -->
        <template if:true={isLoading}>
            <div class="slds-m-around_medium">
                <lightning-spinner
                    alternative-text="Running matching algorithm..."
                    size="medium"
                ></lightning-spinner>
                <p class="slds-text-align_center slds-m-top_small">
                    Finding suitable families for this child...
                </p>
            </div>
        </template>
        
        <!-- Error Message -->
        <template if:true={errorMessage}>
            <div class="slds-m-around_medium">
                <div class="slds-notify slds-notify_alert slds-alert_error" role="alert">
                    <span class="slds-assistive-text">error</span>
                    <lightning-icon icon-name="utility:error" size="x-small" variant="inverse"></lightning-icon>
                    <h2>{errorMessage}</h2>
                </div>
            </div>
        </template>
        
        <!-- Results Section -->
        <template if:true={hasResults}>
            <div class="slds-m-around_medium">
                
                <!-- Summary Stats -->
                <div class="slds-grid slds-gutters slds-m-bottom_medium">
                    <div class="slds-col slds-size_1-of-4">
                        <div class="slds-box slds-text-align_center">
                            <div class="slds-text-heading_large slds-text-color_success">{totalMatches}</div>
                            <div class="slds-text-body_small">Total Matches</div>
                        </div>
                    </div>
                    <div class="slds-col slds-size_1-of-4">
                        <div class="slds-box slds-text-align_center">
                            <div class="slds-text-heading_large slds-text-color_brand">{averageScore}</div>
                            <div class="slds-text-body_small">Avg Score</div>
                        </div>
                    </div>
                    <div class="slds-col slds-size_1-of-4">
                        <div class="slds-box slds-text-align_center">
                            <div class="slds-text-heading_large">{topScore}</div>
                            <div class="slds-text-body_small">Top Score</div>
                        </div>
                    </div>
                    <div class="slds-col slds-size_1-of-4">
                        <div class="slds-box slds-text-align_center">
                            <div class="slds-text-heading_large">{avgDistance}</div>
                            <div class="slds-text-body_small">Avg Distance (mi)</div>
                        </div>
                    </div>
                </div>
                
                <!-- Table View -->
                <template if:true={isTableView}>
                    <lightning-datatable
                        key-field="familyId"
                        data={matchResults}
                        columns={columns}
                        onrowaction={handleRowAction}
                        hide-checkbox-column
                    ></lightning-datatable>
                </template>
                
                <!-- Detailed Card View -->
                <template if:true={isDetailedView}>
                    <template for:each={matchResults} for:item="match">
                        <article key={match.familyId} class="slds-card slds-m-bottom_medium">
                            <div class="slds-card__header slds-grid">
                                <header class="slds-media slds-media_center slds-has-flexi-truncate">
                                    <div class="slds-media__figure">
                                        <lightning-icon icon-name="standard:account" size="medium"></lightning-icon>
                                    </div>
                                    <div class="slds-media__body">
                                        <h2 class="slds-card__header-title">
                                            <a onclick={handleViewFamily} data-id={match.familyId} class="slds-card__header-link">
                                                <span class="slds-text-heading_small">{match.familyName}</span>
                                            </a>
                                        </h2>
                                        <div class="slds-text-body_small slds-text-color_weak">
                                            Capacity: {match.familyCapacity} • {match.licenseStatus} • {match.distanceMiles} miles away
                                        </div>
                                    </div>
                                </header>
                                <div class="slds-no-flex">
                                    <lightning-badge label={match.overallScore} class={match.scoreClass}></lightning-badge>
                                </div>
                            </div>
                            
                            <div class="slds-card__body slds-card__body_inner">
                                <!-- Overall Score Progress Bar -->
                                <div class="slds-m-bottom_medium">
                                    <div class="slds-text-heading_small slds-m-bottom_x-small">Overall Match Score</div>
                                    <lightning-progress-bar 
                                        value={match.overallScore} 
                                        variant={match.progressVariant}
                                        size="large"
                                    ></lightning-progress-bar>
                                </div>
                                
                                <!-- Flags and Alerts -->
                                <template if:true={match.hasFlags}>
                                    <div class="slds-m-bottom_medium">
                                        <div class="slds-notify slds-notify_alert slds-alert_warning" role="alert">
                                            <span class="slds-assistive-text">warning</span>
                                            <lightning-icon icon-name="utility:warning" size="x-small" variant="warning"></lightning-icon>
                                            <h2>
                                                <lightning-formatted-text value={match.flagsString}></lightning-formatted-text>
                                            </h2>
                                        </div>
                                    </div>
                                </template>
                                
                                <!-- Score Breakdown Tabs -->
                                <lightning-tabset variant="scoped">
                                    <!-- Score Breakdown Tab -->
                                    <lightning-tab label="Score Breakdown" icon-name="utility:chart">
                                        <div class="slds-p-around_small">
                                            <!-- High Priority Criteria -->
                                            <div class="slds-m-bottom_medium">
                                                <div class="slds-text-heading_small slds-m-bottom_small">
                                                    <lightning-icon icon-name="utility:priority" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                                    High Priority Criteria
                                                </div>
                                                <div class="score-breakdown-box">
                                                    <template if:true={match.highPriorityDetails}>
                                                        <template for:each={match.highPriorityDetails} for:item="detail">
                                                            <div key={detail.name} class="criterion-row">
                                                                <div class="slds-grid slds-grid_align-spread slds-m-bottom_xx-small">
                                                                    <div class="slds-col">
                                                                        <strong>{detail.name}</strong>
                                                                        <span class="slds-text-body_small slds-m-left_small">
                                                                            (Weight: {detail.weight})
                                                                        </span>
                                                                    </div>
                                                                    <div class="slds-col slds-no-flex">
                                                                        <lightning-badge 
                                                                            label={detail.scoreDisplay}
                                                                            class={detail.badgeClass}
                                                                        ></lightning-badge>
                                                                    </div>
                                                                </div>
                                                                <div class="comparison-grid">
                                                                    <div class="comparison-item preference">
                                                                        <div class="slds-text-body_small slds-text-color_weak">Family Preference</div>
                                                                        <div class="slds-text-body_regular">{detail.preferenceValue}</div>
                                                                    </div>
                                                                    <div class="comparison-arrow">
                                                                        <lightning-icon icon-name="utility:forward" size="xx-small"></lightning-icon>
                                                                    </div>
                                                                    <div class="comparison-item child">
                                                                        <div class="slds-text-body_small slds-text-color_weak">Child's Info</div>
                                                                        <div class="slds-text-body_regular">{detail.childValue}</div>
                                                                    </div>
                                                                </div>
                                                                <div class="slds-m-top_xx-small">
                                                                    <lightning-progress-bar 
                                                                        value={detail.score} 
                                                                        variant={detail.progressVariant}
                                                                    ></lightning-progress-bar>
                                                                </div>
                                                                <template if:true={detail.explanation}>
                                                                    <div class="slds-text-body_small slds-text-color_weak slds-m-top_xx-small">
                                                                        <lightning-icon icon-name="utility:info" size="xx-small"></lightning-icon>
                                                                        {detail.explanation}
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </template>
                                                    </template>
                                                </div>
                                            </div>
                                            
                                            <!-- Medium Priority Criteria -->
                                            <template if:true={match.mediumPriorityDetails}>
                                                <div class="slds-m-bottom_medium">
                                                    <div class="slds-text-heading_small slds-m-bottom_small">
                                                        <lightning-icon icon-name="utility:record" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                                        Medium Priority Criteria
                                                    </div>
                                                    <div class="score-breakdown-box">
                                                        <template for:each={match.mediumPriorityDetails} for:item="detail">
                                                            <div key={detail.name} class="criterion-row">
                                                                <div class="slds-grid slds-grid_align-spread slds-m-bottom_xx-small">
                                                                    <div class="slds-col">
                                                                        <strong>{detail.name}</strong>
                                                                        <span class="slds-text-body_small slds-m-left_small">
                                                                            (Weight: {detail.weight})
                                                                        </span>
                                                                    </div>
                                                                    <div class="slds-col slds-no-flex">
                                                                        <lightning-badge 
                                                                            label={detail.scoreDisplay}
                                                                            class={detail.badgeClass}
                                                                        ></lightning-badge>
                                                                    </div>
                                                                </div>
                                                                <div class="comparison-grid">
                                                                    <div class="comparison-item preference">
                                                                        <div class="slds-text-body_small slds-text-color_weak">Family Preference</div>
                                                                        <div class="slds-text-body_regular">{detail.preferenceValue}</div>
                                                                    </div>
                                                                    <div class="comparison-arrow">
                                                                        <lightning-icon icon-name="utility:forward" size="xx-small"></lightning-icon>
                                                                    </div>
                                                                    <div class="comparison-item child">
                                                                        <div class="slds-text-body_small slds-text-color_weak">Child's Info</div>
                                                                        <div class="slds-text-body_regular">{detail.childValue}</div>
                                                                    </div>
                                                                </div>
                                                                <div class="slds-m-top_xx-small">
                                                                    <lightning-progress-bar 
                                                                        value={detail.score} 
                                                                        variant={detail.progressVariant}
                                                                    ></lightning-progress-bar>
                                                                </div>
                                                                <template if:true={detail.explanation}>
                                                                    <div class="slds-text-body_small slds-text-color_weak slds-m-top_xx-small">
                                                                        <lightning-icon icon-name="utility:info" size="xx-small"></lightning-icon>
                                                                        {detail.explanation}
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <!-- Low Priority Criteria -->
                                            <template if:true={match.lowPriorityDetails}>
                                                <div class="slds-m-bottom_medium">
                                                    <div class="slds-text-heading_small slds-m-bottom_small">
                                                        <lightning-icon icon-name="utility:pin" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                                        Low Priority Criteria
                                                    </div>
                                                    <div class="score-breakdown-box">
                                                        <template for:each={match.lowPriorityDetails} for:item="detail">
                                                            <div key={detail.name} class="criterion-row">
                                                                <div class="slds-grid slds-grid_align-spread slds-m-bottom_xx-small">
                                                                    <div class="slds-col">
                                                                        <strong>{detail.name}</strong>
                                                                        <span class="slds-text-body_small slds-m-left_small">
                                                                            (Weight: {detail.weight})
                                                                        </span>
                                                                    </div>
                                                                    <div class="slds-col slds-no-flex">
                                                                        <lightning-badge 
                                                                            label={detail.scoreDisplay}
                                                                            class={detail.badgeClass}
                                                                        ></lightning-badge>
                                                                    </div>
                                                                </div>
                                                                <div class="comparison-grid">
                                                                    <div class="comparison-item preference">
                                                                        <div class="slds-text-body_small slds-text-color_weak">Family Preference</div>
                                                                        <div class="slds-text-body_regular">{detail.preferenceValue}</div>
                                                                    </div>
                                                                    <div class="comparison-arrow">
                                                                        <lightning-icon icon-name="utility:forward" size="xx-small"></lightning-icon>
                                                                    </div>
                                                                    <div class="comparison-item child">
                                                                        <div class="slds-text-body_small slds-text-color_weak">Child's Info</div>
                                                                        <div class="slds-text-body_regular">{detail.childValue}</div>
                                                                    </div>
                                                                </div>
                                                                <div class="slds-m-top_xx-small">
                                                                    <lightning-progress-bar 
                                                                        value={detail.score} 
                                                                        variant={detail.progressVariant}
                                                                    ></lightning-progress-bar>
                                                                </div>
                                                                <template if:true={detail.explanation}>
                                                                    <div class="slds-text-body_small slds-text-color_weak slds-m-top_xx-small">
                                                                        <lightning-icon icon-name="utility:info" size="xx-small"></lightning-icon>
                                                                        {detail.explanation}
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <!-- Score Calculation Summary -->
                                            <div class="calculation-summary">
                                                <div class="slds-text-heading_small slds-m-bottom_small">
                                                    Score Calculation
                                                </div>
                                                <div class="slds-box">
                                                    <dl class="slds-dl_horizontal">
                                                        <dt class="slds-dl_horizontal__label">High Priority Score:</dt>
                                                        <dd class="slds-dl_horizontal__detail">{match.highPriorityScore}%</dd>
                                                        
                                                        <dt class="slds-dl_horizontal__label">Medium Priority Score:</dt>
                                                        <dd class="slds-dl_horizontal__detail">{match.mediumPriorityScore}%</dd>
                                                        
                                                        <dt class="slds-dl_horizontal__label">Low Priority Score:</dt>
                                                        <dd class="slds-dl_horizontal__detail">{match.lowPriorityScore}%</dd>
                                                        
                                                        <dt class="slds-dl_horizontal__label">Distance Adjustment:</dt>
                                                        <dd class="slds-dl_horizontal__detail">{match.distanceAdjustment}</dd>
                                                        
                                                        <dt class="slds-dl_horizontal__label slds-text-heading_small">Final Score:</dt>
                                                        <dd class="slds-dl_horizontal__detail slds-text-heading_small">
                                                            <strong>{match.overallScore}</strong>
                                                        </dd>
                                                    </dl>
                                                </div>
                                            </div>
                                        </div>
                                    </lightning-tab>
                                    
                                    <!-- Match Reasons Tab -->
                                    <lightning-tab label="Why Matched" icon-name="utility:success">
                                        <div class="slds-p-around_small">
                                            <ul class="slds-list_dotted">
                                                <template for:each={match.matchReasons} for:item="reason">
                                                    <li key={reason} class="slds-m-bottom_x-small">
                                                        <lightning-icon icon-name="utility:check" size="xx-small" class="slds-m-right_x-small slds-text-color_success"></lightning-icon>
                                                        {reason}
                                                    </li>
                                                </template>
                                            </ul>
                                        </div>
                                    </lightning-tab>
                                    
                                    <!-- Family Details Tab -->
                                    <lightning-tab label="Family Details" icon-name="utility:groups">
                                        <div class="slds-p-around_small">
                                            <dl class="slds-dl_horizontal">
                                                <dt class="slds-dl_horizontal__label">Family Name:</dt>
                                                <dd class="slds-dl_horizontal__detail">{match.familyName}</dd>
                                                
                                                <dt class="slds-dl_horizontal__label">Available Capacity:</dt>
                                                <dd class="slds-dl_horizontal__detail">{match.familyCapacity}</dd>
                                                
                                                <dt class="slds-dl_horizontal__label">License Status:</dt>
                                                <dd class="slds-dl_horizontal__detail">{match.licenseStatus}</dd>
                                                
                                                <dt class="slds-dl_horizontal__label">Distance:</dt>
                                                <dd class="slds-dl_horizontal__detail">{match.distanceMiles} miles</dd>
                                            </dl>
                                        </div>
                                    </lightning-tab>
                                </lightning-tabset>
                            </div>
                            
                            <footer class="slds-card__footer">
                                <div class="slds-grid slds-grid_align-spread">
                                    <div class="slds-col">
                                        <lightning-button
                                            label="View Preference"
                                            icon-name="utility:preview"
                                            onclick={handleViewPreference}
                                            data-id={match.preferenceId}
                                        ></lightning-button>
                                    </div>
                                    <div class="slds-col slds-no-flex">
                                        <lightning-button
                                            label="View Family Record"
                                            variant="brand"
                                            icon-name="utility:new_window"
                                            onclick={handleViewFamily}
                                            data-id={match.familyId}
                                        ></lightning-button>
                                    </div>
                                </div>
                            </footer>
                        </article>
                    </template>
                </template>
            </div>
        </template>
        
        <!-- No Results Message -->
        <template if:false={hasResults}>
            <template if:false={isLoading}>
                <template if:false={errorMessage}>
                    <div class="slds-m-around_medium slds-text-align_center">
                        <div class="slds-illustration slds-illustration_small">
                            <img src="/img/chatter/OpenRoad.svg" class="slds-illustration__svg" alt="No matches" />
                            <div class="slds-text-longform">
                                <h3 class="slds-text-heading_medium">No Matches Found</h3>
                                <p class="slds-text-body_regular">
                                    Click "Run Matching" to find suitable families for this child.
                                </p>
                            </div>
                        </div>
                    </div>
                </template>
            </template>
        </template>
    </lightning-card>
</template>